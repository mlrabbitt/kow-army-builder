<html>
  <head>
    <script src="https://unpkg.com/react@latest/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@latest/dist/react-dom.js"></script>
    <script src="https://unpkg.com/babel-standalone@latest/babel.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  </head>
  <style>
    ul {
      list-style-type: none;
    }
    #flex {
      display: flex;
    }
  </style>
  <body>
    <div id="root">
    </div>
    <script>
      var kow;

      $.ajaxSetup({
        async: false
      });
      $.getJSON('https://cdn.rawgit.com/mlrabbitt/kow-army-builder/master/kow.pretty.json', function(data) {
        kow = data;
      });
    </script>
    <script type="text/babel">
      class Builder extends React.Component {
        constructor (props) {
          super(props);
          this.handleArmyChange = this.handleArmyChange.bind(this);
          this.handleUnitChange = this.handleUnitChange.bind(this);
          this.state = {selectedArmy: 0, selectedUnit: null, variations: null};
        }

        handleArmyChange(value) {
          this.setState({selectedArmy: value, selectedUnit: null, variations: null});
        }
        handleUnitChange(value) {
          this.setState({selectedUnit: value, variations: this.props.kow[this.state.selectedArmy].units[value].variations});
        }

        render() {
          return (
            <div id="flex">
              <Armies kow={this.props.kow}
                    selectedArmy={this.state.selectedArmy}
                    onChange={this.handleArmyChange} />
              <Units units={this.props.kow[this.state.selectedArmy].units} 
                     selectedUnit={this.state.selectedUnit}
                     variations={this.state.variations}
                     onChange={this.handleUnitChange} />
            </div>
          );
        }
      }

      class Armies extends React.Component {
        constructor(props) {
          super(props);
          this.handleChange = this.handleChange.bind(this);
        }
     
        handleChange(e) {
          this.props.onChange(e.target.value);
        }

        render() {
          return (
            <div id="armies">
              <ul>
                {this.props.kow.map(army => (
                  army.id == this.props.selectedArmy ? <li key={army.id} value={army.id} onClick={this.handleChange}><b>{army.name}</b></li> : <li key={army.id} value={army.id} onClick={this.handleChange}>{army.name}</li>
                ))}
              </ul>
            </div>
          );
        }
      }

      class Units extends React.Component {
        constructor(props) {
          super(props);
          this.handleChange = this.handleChange.bind(this);
        }

        handleChange(e) {
          this.props.onChange(e.target.value);
        }

        render () {
          return (
            <div id="units">
              <ul>
                {this.props.units.map((unit, index) => (
                  index == this.props.selectedUnit ? [<li key={index} value={index} onClick={this.handleChange}><b>{unit.name}</b></li>, <Variations variations={this.props.variations} />] : <li key={index} value={index} onClick={this.handleChange}>{unit.name}</li>
              ))}
              </ul>
            </div>
          );
        }
      }

      class Variations extends React.Component {
        constructor(props) {
          super(props);
        }

        render() {
          return (
            <table>
              <tbody>
                <tr>
                  <th>Type</th><th>Size</th><th>Sp</th><th>Me</th><th>Ra</th><th>De</th><th>At</th><th>Ne</th><th>Pt</th><th>Rules</th><th>Options</th>
                </tr>
                  {this.props.variations.map(vari => (
                    <tr key={vari.id}>
                      <td>{vari.type}</td><td>{vari.s_type}</td><td>{vari.speed}</td><td>{vari.melee}</td><td>{vari.range}</td><td>{vari.defense}</td><td>{vari.attack}</td><td>{vari.nerve}</td><td>{vari.points}</td><td>{vari.rules}</td><td>{vari.options}</td>
                    </tr>
                  ))}
              </tbody>
            </table>
          );
        }

      }

      ReactDOM.render(
        <Builder kow={kow} />,
        document.getElementById('root')
      );
    </script>
    </script>
  </body>
</html>
